{% extends "base.html" %}

{% block title %}Settings - Simple Storage{% endblock %}

{% block body %}
<div class="app-layout">
    {% include "partials/sidebar.html" %}
    
    <!-- Main Content -->
    <main class="main-content">
        <div class="page-header">
            <h1 class="page-title">‚öôÔ∏è Settings</h1>
            <p class="page-subtitle">Configura la pulizia automatica e le impostazioni</p>
        </div>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} mb-3">
                    <span class="alert-icon">{% if category == 'success' %}‚úÖ{% else %}‚ö†Ô∏è{% endif %}</span>
                    <div class="alert-content">{{ message }}</div>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <!-- Cleanup Settings Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h2 class="card-title">üßπ Cleanup Automatico</h2>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('admin_cron') }}" id="cron-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    
                    <div class="settings-section">
                        <div class="settings-row">
                            <div class="settings-row-label">
                                <h4>Cleanup Automatico</h4>
                                <p>Abilita o disabilita la pulizia automatica dei file vecchi</p>
                            </div>
                            <div class="settings-row-control">
                                <label class="toggle">
                                    <input type="checkbox" name="cleanup_enabled" id="cleanup_enabled" 
                                           {% if settings.cleanup_enabled %}checked{% endif %}>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="settings-row">
                            <div class="settings-row-label">
                                <h4>Et√† Massima File</h4>
                                <p>Elimina i file pi√π vecchi di questo numero di ore (file gi√† scaricati)</p>
                            </div>
                            <div class="settings-row-control">
                                <div class="input-with-suffix">
                                    <input type="number" name="cleanup_max_age_hours" 
                                           class="form-input form-input-sm" 
                                           value="{{ settings.cleanup_max_age_hours }}"
                                           min="1" max="8760">
                                    <span class="input-suffix">ore</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2 mt-4">
                        <button type="submit" class="btn btn-primary">
                            üíæ Salva Impostazioni
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Run Now Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h2 class="card-title">üöÄ Esecuzione Immediata</h2>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-3">
                    <span class="alert-icon">‚ÑπÔ∏è</span>
                    <div class="alert-content">
                        <div class="alert-title">Come funziona il cleanup</div>
                        Il cleanup elimina i file che sono stati scaricati (downloaded_at non nullo) 
                        e che sono pi√π vecchi dell'et√† massima configurata.
                    </div>
                </div>
                
                <form method="POST" action="{{ url_for('admin_cron_run') }}" id="run-now-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-success" id="run-now-btn">
                        <span id="run-now-text">‚ö° Esegui Cleanup Ora</span>
                        <span class="spinner hidden" id="run-now-spinner"></span>
                    </button>
                </form>
                
                {% if settings.cleanup_last_run %}
                <p class="text-muted mt-3">
                    üìÖ Ultima esecuzione: {{ settings.cleanup_last_run_human }}
                </p>
                {% endif %}
            </div>
        </div>
        
        <!-- Logo Upload Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h2 class="card-title">üé® Logo Personalizzato</h2>
            </div>
            <div class="card-body">
                <div class="settings-row">
                    <div class="settings-row-label">
                        <h4>Carica Logo</h4>
                        <p>Carica un logo personalizzato (PNG, max 500KB, consigliato: 100x100px)</p>
                    </div>
                </div>
                
                <form method="POST" action="{{ url_for('admin_upload_logo') }}" enctype="multipart/form-data" class="mt-3">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="d-flex gap-2 align-center">
                        <input type="file" name="logo" accept="image/png,image/jpeg,image/svg+xml" class="form-input" style="flex: 1;">
                        <button type="submit" class="btn btn-secondary">üì§ Upload</button>
                    </div>
                </form>
                
                <div class="mt-3">
                    <p class="text-muted">Logo attuale:</p>
                    <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Current Logo" 
                         style="max-width: 80px; max-height: 80px; margin-top: 0.5rem; border-radius: 8px;"
                         onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2280%22>üì¶</text></svg>'">
                </div>
            </div>
        </div>
        
        <!-- Cron Info Card -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">üìñ Guida Cron Server</h2>
            </div>
            <div class="card-body">
                <div class="alert alert-warning mb-3">
                    <span class="alert-icon">‚ö†Ô∏è</span>
                    <div class="alert-content">
                        <div class="alert-title">Nota Importante</div>
                        Il cleanup automatico richiede la configurazione di un cron job sul server.
                        Segui le istruzioni qui sotto per configurarlo.
                    </div>
                </div>
                
                <h4 class="mb-2">1. Verifica che cron sia attivo</h4>
                <pre class="code-block">sudo systemctl status cron</pre>
                
                <h4 class="mb-2 mt-3">2. Se non √® attivo, avvialo</h4>
                <pre class="code-block">sudo systemctl enable cron
sudo systemctl start cron</pre>
                
                <h4 class="mb-2 mt-3">3. Aggiungi un cron job per il cleanup</h4>
                <pre class="code-block"># Apri l'editor cron
crontab -e

# Aggiungi questa riga per eseguire il cleanup ogni ora:
0 * * * * curl -X POST http://localhost:5000/api/cleanup -H "X-API-Key: YOUR_API_KEY"</pre>
                
                <h4 class="mb-2 mt-3">4. Verifica i cron job</h4>
                <pre class="code-block">crontab -l</pre>
            </div>
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script>
// Run now form
document.getElementById('run-now-form').addEventListener('submit', function() {
    const btn = document.getElementById('run-now-btn');
    const text = document.getElementById('run-now-text');
    const spinner = document.getElementById('run-now-spinner');
    btn.disabled = true;
    text.textContent = 'Esecuzione in corso...';
    spinner.classList.remove('hidden');
});
</script>
{% endblock %}
