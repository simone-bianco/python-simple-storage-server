{% extends "base.html" %}

{% block title %}Storage - Simple Storage{% endblock %}

{% block body %}
<div class="app-layout">
    {% include "partials/sidebar.html" %}
    
    <!-- Main Content -->
    <main class="main-content">
        <div class="page-header">
            <h1 class="page-title">üìÅ Storage</h1>
            <p class="page-subtitle">Gestisci i file caricati sul server</p>
        </div>
        
        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon primary">üì¶</div>
                <div class="stat-content">
                    <div class="stat-value" id="stat-total">{{ stats.total }}</div>
                    <div class="stat-label">File Totali</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon success">‚úÖ</div>
                <div class="stat-content">
                    <div class="stat-value" id="stat-active">{{ stats.active }}</div>
                    <div class="stat-label">File Attivi</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon warning">üì•</div>
                <div class="stat-content">
                    <div class="stat-value" id="stat-downloaded">{{ stats.downloaded }}</div>
                    <div class="stat-label">Scaricati</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon accent">üíæ</div>
                <div class="stat-content">
                    <div class="stat-value" id="stat-size">{{ stats.total_size_human }}</div>
                    <div class="stat-label">Spazio Usato</div>
                </div>
            </div>
        </div>
        
        <!-- Files Table -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">üìã Lista File</h2>
                <div class="d-flex gap-2">
                    <button class="btn btn-secondary btn-sm" onclick="refreshFiles()">
                        üîÑ Aggiorna
                    </button>
                </div>
            </div>
            
            <div class="table-wrapper">
                <table class="table" id="files-table">
                    <thead>
                        <tr>
                            <th>Job ID</th>
                            <th>Dimensione</th>
                            <th>Caricato</th>
                            <th>Scaricato</th>
                            <th>Stato</th>
                            <th class="text-right">Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="files-tbody">
                        {% if files %}
                            {% for file in files %}
                            <tr data-job-id="{{ file.job_id }}">
                                <td>
                                    <code class="table-cell-truncate" title="{{ file.job_id }}">{{ file.job_id }}</code>
                                </td>
                                <td>{{ file.file_size_human }}</td>
                                <td>{{ file.uploaded_at_human }}</td>
                                <td>{{ file.downloaded_at_human if file.downloaded_at else '-' }}</td>
                                <td>
                                    {% if file.deleted %}
                                        <span class="badge badge-danger">Eliminato</span>
                                    {% elif file.downloaded_at %}
                                        <span class="badge badge-warning">Scaricato</span>
                                    {% else %}
                                        <span class="badge badge-success">Disponibile</span>
                                    {% endif %}
                                </td>
                                <td class="text-right">
                                    {% if not file.deleted %}
                                    <a href="{{ url_for('admin_download_file', job_id=file.job_id) }}" 
                                       class="btn btn-primary btn-sm" 
                                       title="Scarica file">
                                        üì• Download
                                    </a>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="6">
                                    <div class="empty-state">
                                        <div class="empty-state-icon">üìÇ</div>
                                        <h3 class="empty-state-title">Nessun file trovato</h3>
                                        <p class="empty-state-message">
                                            Non ci sono file caricati sul server. I file appariranno qui dopo l'upload.
                                        </p>
                                    </div>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            
            {% if total_pages > 1 %}
            <div class="card-footer">
                <div class="pagination">
                    <div class="pagination-info">
                        Pagina {{ page }} di {{ total_pages }} ({{ total_files }} file totali)
                    </div>
                    <div class="pagination-controls">
                        {% if page > 1 %}
                        <a href="{{ url_for('admin_dashboard', page=page-1) }}" class="pagination-btn">‚Üê Precedente</a>
                        {% endif %}
                        
                        {% for p in range(1, total_pages + 1) %}
                            {% if p == page %}
                            <span class="pagination-btn active">{{ p }}</span>
                            {% elif p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %}
                            <a href="{{ url_for('admin_dashboard', page=p) }}" class="pagination-btn">{{ p }}</a>
                            {% elif p == page - 3 or p == page + 3 %}
                            <span class="pagination-btn" style="pointer-events: none;">...</span>
                            {% endif %}
                        {% endfor %}
                        
                        {% if page < total_pages %}
                        <a href="{{ url_for('admin_dashboard', page=page+1) }}" class="pagination-btn">Successiva ‚Üí</a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script>
function refreshFiles() {
    window.location.reload();
}
</script>
{% endblock %}
